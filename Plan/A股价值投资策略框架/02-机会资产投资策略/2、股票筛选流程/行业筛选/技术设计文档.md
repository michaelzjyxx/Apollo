# iFinD行业筛选自动化系统 - 技术设计文档

**版本**: v1.0
**日期**: 2026-01-18
**状态**: 开发中

---

## 一、系统架构设计

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        应用层 (Application)                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────┐  │
│  │ Streamlit Web UI │  │  CLI 命令行工具   │  │  API Server  │  │
│  └────────┬─────────┘  └────────┬─────────┘  └──────┬───────┘  │
└───────────┼─────────────────────┼────────────────────┼──────────┘
            │                     │                    │
┌───────────┼─────────────────────┼────────────────────┼──────────┐
│           │         业务逻辑层 (Business Logic)        │           │
│  ┌────────▼────────────────────▼────────────────────▼───────┐  │
│  │                    核心引擎 (Core Engine)                 │  │
│  │  ┌────────────┐  ┌────────────┐  ┌───────────────────┐  │  │
│  │  │ 评分引擎   │  │ 回测引擎   │  │   调度引擎        │  │  │
│  │  │ (Scorer)   │  │ (Backtester)│  │  (Scheduler)      │  │  │
│  │  └────────────┘  └────────────┘  └───────────────────┘  │  │
│  │  ┌────────────┐  ┌────────────┐  ┌───────────────────┐  │  │
│  │  │ 计算引擎   │  │ 数据验证   │  │   配置管理        │  │  │
│  │  │(Calculator)│  │ (Validator)│  │(Config Manager)   │  │  │
│  │  └────────────┘  └────────────┘  └───────────────────┘  │  │
│  └─────────────────────────────────────────────────────────┘  │
└───────────┼──────────────────────────────────────────────────────┘
            │
┌───────────▼──────────────────────────────────────────────────────┐
│                      数据访问层 (Data Access)                      │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────┐  │
│  │   MySQL ORM      │  │   数据仓库模式    │  │   缓存层     │  │
│  │  (SQLAlchemy)    │  │  (Repository)    │  │   (Redis)    │  │
│  └────────┬─────────┘  └────────┬─────────┘  └──────┬───────┘  │
└───────────┼─────────────────────┼────────────────────┼──────────┘
            │                     │                    │
┌───────────▼─────────────────────▼────────────────────▼──────────┐
│                        数据层 (Data Layer)                        │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────┐  │
│  │  iFinD API       │  │   MySQL DB       │  │  File System │  │
│  │  (数据源)         │  │ (主数据库)        │  │  (日志/配置) │  │
│  └──────────────────┘  └──────────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈详细说明

| 类别 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **开发语言** | Python | 3.10+ | 核心开发语言 |
| **数据库** | MySQL | 8.0+ | 主数据存储 |
| **ORM框架** | SQLAlchemy | 2.0+ | 数据库ORM映射 |
| **数据分析** | Pandas | 2.0+ | 数据处理 |
| **数值计算** | NumPy | 1.24+ | 数值计算 |
| **可视化** | Plotly | 5.14+ | 交互式图表 |
| **Web框架** | Streamlit | 1.28+ | 前端界面 |
| **任务调度** | APScheduler | 3.10+ | 定时任务 |
| **配置管理** | YAML + Pydantic | - | 配置文件管理 |
| **日志** | Loguru | 0.7+ | 日志记录 |
| **测试** | Pytest | 7.4+ | 单元测试 |
| **缓存**(可选) | Redis | 7.0+ | 数据缓存 |

---

## 二、项目目录结构

```
industry_screener/
├── config/                          # 配置文件目录
│   ├── config.yaml                  # 主配置文件
│   ├── scoring_weights.yaml         # 评分权重配置
│   ├── industry_qualitative.yaml    # 行业定性评分预设库
│   └── api_config.yaml              # API配置(账号、频率限制等)
│
├── src/                             # 源代码目录
│   ├── __init__.py
│   │
│   ├── core/                        # 核心业务逻辑
│   │   ├── __init__.py
│   │   ├── calculator.py            # 计算引擎
│   │   ├── scorer.py                # 评分引擎
│   │   ├── backtester.py            # 回测引擎
│   │   ├── scheduler.py             # 调度引擎
│   │   └── validator.py             # 数据验证器
│   │
│   ├── data/                        # 数据访问层
│   │   ├── __init__.py
│   │   ├── ifind_api.py             # iFinD API封装
│   │   ├── database.py              # 数据库连接管理
│   │   ├── models.py                # SQLAlchemy模型定义
│   │   ├── repository.py            # 数据仓库模式实现
│   │   └── cache.py                 # 缓存管理(可选)
│   │
│   ├── utils/                       # 工具函数
│   │   ├── __init__.py
│   │   ├── config_loader.py         # 配置加载器
│   │   ├── logger.py                # 日志配置
│   │   ├── date_utils.py            # 日期工具
│   │   └── constants.py             # 常量定义
│   │
│   ├── ui/                          # 用户界面
│   │   ├── __init__.py
│   │   ├── streamlit_app.py         # Streamlit主应用
│   │   ├── pages/                   # 多页面应用
│   │   │   ├── 1_overview.py        # 总览页
│   │   │   ├── 2_industry_detail.py # 行业详情页
│   │   │   ├── 3_trend_analysis.py  # 趋势分析页
│   │   │   ├── 4_redline_monitor.py # 红线监控页
│   │   │   └── 5_backtest.py        # 回测页
│   │   └── components/              # UI组件
│   │       ├── charts.py            # 图表组件
│   │       ├── tables.py            # 表格组件
│   │       └── filters.py           # 筛选器组件
│   │
│   └── cli/                         # 命令行工具
│       ├── __init__.py
│       ├── main.py                  # CLI主入口
│       ├── commands/                # 命令实现
│       │   ├── fetch_data.py        # 数据获取命令
│       │   ├── calculate.py         # 计算命令
│       │   ├── score.py             # 评分命令
│       │   └── backtest.py          # 回测命令
│       └── utils.py                 # CLI工具函数
│
├── tests/                           # 测试目录
│   ├── __init__.py
│   ├── conftest.py                  # Pytest配置
│   ├── test_calculator.py           # 计算引擎测试
│   ├── test_scorer.py               # 评分引擎测试
│   ├── test_ifind_api.py            # API测试
│   └── test_integration.py          # 集成测试
│
├── scripts/                         # 脚本目录
│   ├── init_database.py             # 数据库初始化
│   ├── migrate_schema.py            # Schema迁移
│   ├── fetch_historical_data.py     # 批量获取历史数据
│   └── deploy.sh                    # 部署脚本
│
├── data/                            # 数据文件目录(Git忽略)
│   ├── logs/                        # 日志文件
│   ├── cache/                       # 缓存文件
│   └── exports/                     # 导出文件
│
├── docs/                            # 文档目录
│   ├── user_guide.md                # 用户手册
│   ├── api_reference.md             # API参考文档
│   ├── deployment.md                # 部署指南
│   └── development.md               # 开发指南
│
├── .env.example                     # 环境变量示例
├── .gitignore                       # Git忽略文件
├── requirements.txt                 # Python依赖
├── setup.py                         # 安装配置
├── pytest.ini                       # Pytest配置
├── README.md                        # 项目说明
└── LICENSE                          # 许可证
```

---

## 三、核心模块设计

### 3.1 数据获取模块 (iFinD API封装)

#### 3.1.1 类设计

```python
# src/data/ifind_api.py

from typing import List, Dict, Optional, Union
from datetime import datetime, date
import pandas as pd
from loguru import logger

class IFindAPIClient:
    """iFinD API客户端封装"""

    def __init__(self, config: dict):
        """
        初始化API客户端

        Args:
            config: API配置字典，包含:
                - username: 用户名
                - password: 密码
                - max_retries: 最大重试次数
                - retry_interval: 重试间隔(秒)
                - rate_limit: 频率限制(次/秒)
        """
        self.username = config['username']
        self.password = config['password']
        self.max_retries = config.get('max_retries', 3)
        self.retry_interval = config.get('retry_interval', 5)
        self.rate_limit = config.get('rate_limit', 1)
        self._session = None
        self._last_request_time = None

    def connect(self) -> bool:
        """建立API连接"""
        pass

    def disconnect(self):
        """断开API连接"""
        pass

    def fetch_industry_indicator(
        self,
        industry_codes: List[str],
        indicator_code: str,
        start_date: Union[str, date],
        end_date: Union[str, date],
        frequency: str = 'Q'  # D/W/M/Q/Y
    ) -> pd.DataFrame:
        """
        获取行业指标数据

        Args:
            industry_codes: 行业代码列表,如['801010.SI', '801020.SI']
            indicator_code: 指标代码,如'ROE', 'CR5'
            start_date: 开始日期
            end_date: 结束日期
            frequency: 数据频率 D=日度,W=周度,M=月度,Q=季度,Y=年度

        Returns:
            DataFrame with columns: [industry_code, date, value]
        """
        pass

    def fetch_macro_indicator(
        self,
        indicator_code: str,
        start_date: Union[str, date],
        end_date: Union[str, date]
    ) -> pd.DataFrame:
        """
        获取宏观指标数据(PMI, PPI, CPI, M2, 社融等)

        Args:
            indicator_code: 宏观指标代码
            start_date: 开始日期
            end_date: 结束日期

        Returns:
            DataFrame with columns: [date, value]
        """
        pass

    def fetch_fund_flow(
        self,
        industry_codes: List[str],
        flow_type: str,  # 'northbound' or 'main_fund'
        start_date: Union[str, date],
        end_date: Union[str, date]
    ) -> pd.DataFrame:
        """
        获取资金流向数据

        Args:
            industry_codes: 行业代码列表
            flow_type: 资金类型 'northbound'=北向资金, 'main_fund'=主力资金
            start_date: 开始日期
            end_date: 结束日期

        Returns:
            DataFrame with columns: [industry_code, date, flow_amount]
        """
        pass

    def fetch_industry_index_return(
        self,
        industry_codes: List[str],
        start_date: Union[str, date],
        end_date: Union[str, date]
    ) -> pd.DataFrame:
        """
        获取行业指数收益率(用于回测)

        Args:
            industry_codes: 行业代码列表
            start_date: 开始日期
            end_date: 结束日期

        Returns:
            DataFrame with columns: [industry_code, date, return_pct]
        """
        pass

    def fetch_top_stocks_by_industry(
        self,
        industry_code: str,
        top_n: int = 3,
        date: Union[str, date] = None
    ) -> List[Dict]:
        """
        获取行业龙头股(按市值)

        Args:
            industry_code: 行业代码
            top_n: 取前N名
            date: 查询日期,None表示最新

        Returns:
            List of dict: [{'stock_code': 'xxx', 'stock_name': 'xxx', 'market_cap': xxx}]
        """
        pass

    def _rate_limit_check(self):
        """频率限制检查"""
        pass

    def _retry_on_failure(self, func, *args, **kwargs):
        """失败重试装饰器"""
        pass
```

#### 3.1.2 指标代码映射表

```yaml
# config/api_config.yaml

indicator_mapping:
  # 竞争格局
  cr5: 'THS_CR5'                    # 行业集中度CR5
  leader_share: 'THS_LEADER_SHARE'  # 龙头市场份额
  capacity_util: 'THS_CAP_UTIL'     # 产能利用率

  # 盈利能力
  roe: 'THS_ROE_TTM'                # ROE(TTM)
  gross_margin: 'THS_GP_MARGIN_TTM' # 毛利率(TTM)

  # 成长性
  revenue_growth: 'THS_REV_YOY_TTM' # 营收增速(TTM)
  profit_growth: 'THS_NP_YOY_TTM'   # 利润增速(TTM)

  # 现金流
  ocf_ni_ratio: 'THS_OCF_NI_RATIO'  # 经营现金流/净利润
  capex_da: 'THS_CAPEX_DA_RATIO'    # 资本支出/折旧

  # 估值
  pe_ttm: 'THS_PE_TTM'              # PE(TTM)
  pb: 'THS_PB'                      # PB
  profit_forecast: 'THS_NP_FORECAST'# 利润预测增速

  # 宏观指标
  pmi: 'MI00000227'                 # 制造业PMI
  new_order: 'MI00000228'           # 新订单指数
  m2: 'MI00000141'                  # M2同比
  social_financing: 'MI00000142'    # 社融同比
  ppi: 'MI00000612'                 # PPI同比
  cpi: 'MI00000613'                 # CPI同比

  # 周期位置
  inventory_yoy: 'THS_INV_YOY'      # 存货同比
  inventory_turnover: 'THS_INV_DAYS'# 存货周转天数

  # 资金流向
  northbound_flow: 'THS_HK_FLOW'    # 北向资金流入
  main_fund_flow: 'THS_MAIN_FLOW'   # 主力资金流入

# 申万一级行业代码
shenwan_l1_industries:
  - code: '801010.SI'
    name: '农林牧渔'
  - code: '801020.SI'
    name: '采掘'
  - code: '801030.SI'
    name: '化工'
  # ... 其余28个行业
```

---

### 3.2 数据库设计

#### 3.2.1 SQLAlchemy模型定义

```python
# src/data/models.py

from sqlalchemy import Column, Integer, String, Float, Date, DateTime, Text, Index
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.sql import func
from datetime import datetime

Base = declarative_base()

class RawData(Base):
    """原始数据表"""
    __tablename__ = 'raw_data'

    id = Column(Integer, primary_key=True, autoincrement=True)
    industry_code = Column(String(10), nullable=False, index=True)
    industry_name = Column(String(50), nullable=False)
    indicator_code = Column(String(20), nullable=False, index=True)
    indicator_value = Column(Float)
    data_date = Column(Date, nullable=False, index=True)
    update_time = Column(DateTime, default=func.now(), onupdate=func.now())
    data_source = Column(String(20), default='iFinD')

    # 复合索引,优化查询性能
    __table_args__ = (
        Index('idx_industry_indicator_date',
              'industry_code', 'indicator_code', 'data_date'),
    )

    def __repr__(self):
        return f"<RawData({self.industry_code}, {self.indicator_code}, {self.data_date})>"


class CalculatedIndicators(Base):
    """计算指标表"""
    __tablename__ = 'calculated_indicators'

    id = Column(Integer, primary_key=True, autoincrement=True)
    industry_code = Column(String(10), nullable=False, index=True)
    industry_name = Column(String(50), nullable=False)
    calc_date = Column(Date, nullable=False, index=True)

    # 竞争格局指标
    cr5 = Column(Float, comment='行业集中度CR5')
    leader_share_change = Column(Float, comment='龙头份额变化')
    price_volatility = Column(Float, comment='价格波动率')
    capacity_utilization = Column(Float, comment='产能利用率')

    # 盈利能力指标
    roe_avg = Column(Float, comment='行业平均ROE')
    roe_percentile = Column(Float, comment='ROE历史分位')
    gross_margin_avg = Column(Float, comment='行业平均毛利率')
    gross_margin_trend = Column(String(10), comment='毛利率趋势:上行/平稳/下行')

    # 成长性指标
    revenue_growth = Column(Float, comment='营收增速')
    profit_growth = Column(Float, comment='利润增速')
    profit_elasticity = Column(Float, comment='利润弹性=利润增速/收入增速')

    # 现金流指标
    ocf_ni_ratio = Column(Float, comment='经营现金流/净利润')
    capex_intensity = Column(Float, comment='资本支出强度')

    # 估值指标
    pe_ttm = Column(Float, comment='PE(TTM)')
    pe_percentile = Column(Float, comment='PE历史分位')
    pb = Column(Float, comment='PB')
    pb_percentile = Column(Float, comment='PB历史分位')
    peg = Column(Float, comment='PEG')

    # 景气度指标
    pmi = Column(Float, comment='制造业PMI')
    new_order = Column(Float, comment='新订单指数')
    m2_growth = Column(Float, comment='M2同比增速')
    social_financing_growth = Column(Float, comment='社融同比增速')
    ppi_yoy = Column(Float, comment='PPI同比')
    cpi_yoy = Column(Float, comment='CPI同比')

    # 周期位置指标
    inventory_yoy = Column(Float, comment='存货同比')
    inventory_turnover_days = Column(Float, comment='库存周转天数')
    inventory_cycle_position = Column(String(20), comment='库存周期位置')

    # 资金流向
    northbound_flow_4w = Column(Float, comment='北向资金4周流入(亿)')
    main_fund_flow_4w = Column(Float, comment='主力资金4周流入(亿)')

    update_time = Column(DateTime, default=func.now(), onupdate=func.now())

    __table_args__ = (
        Index('idx_industry_calc_date', 'industry_code', 'calc_date'),
    )

    def __repr__(self):
        return f"<CalculatedIndicators({self.industry_code}, {self.calc_date})>"


class Scores(Base):
    """评分表"""
    __tablename__ = 'scores'

    id = Column(Integer, primary_key=True, autoincrement=True)
    industry_code = Column(String(10), nullable=False, index=True)
    industry_name = Column(String(50), nullable=False)
    score_date = Column(Date, nullable=False, index=True)

    # 分项得分(定量70分)
    competition_score = Column(Float, default=0, comment='竞争格局15分')
    profitability_score = Column(Float, default=0, comment='盈利能力15分')
    growth_score = Column(Float, default=0, comment='成长性10分')
    cashflow_score = Column(Float, default=0, comment='现金流10分')
    valuation_score = Column(Float, default=0, comment='估值10分')
    sentiment_score = Column(Float, default=0, comment='景气度5分')
    cycle_score = Column(Float, default=0, comment='周期位置5分')

    # 定性评分(20分)
    policy_score = Column(Float, default=0, comment='政策环境5分')
    business_model_score = Column(Float, default=0, comment='商业模式5分')
    barrier_score = Column(Float, default=0, comment='进入壁垒5分')
    moat_score = Column(Float, default=0, comment='护城河5分')

    # 调整分(±10分)
    macro_adjustment = Column(Float, default=0, comment='宏观调整±5分')
    redline_penalty = Column(Float, default=0, comment='红线扣分-10分')

    # 总分
    total_score = Column(Float, default=0, comment='总分100分')

    # 红线触发
    redline_triggered = Column(Text, comment='触发的红线项,逗号分隔')

    update_time = Column(DateTime, default=func.now(), onupdate=func.now())

    __table_args__ = (
        Index('idx_industry_score_date', 'industry_code', 'score_date'),
        Index('idx_score_date_total', 'score_date', 'total_score'),
    )

    def __repr__(self):
        return f"<Scores({self.industry_code}, {self.score_date}, {self.total_score})>"


class BacktestResults(Base):
    """回测结果表"""
    __tablename__ = 'backtest_results'

    id = Column(Integer, primary_key=True, autoincrement=True)
    backtest_date = Column(Date, nullable=False, index=True, comment='回测日期')
    rebalance_date = Column(Date, nullable=False, comment='调仓日期')
    strategy_name = Column(String(50), nullable=False, comment='策略名称')
    selected_industries = Column(Text, comment='选中的行业,逗号分隔')
    portfolio_return = Column(Float, comment='组合收益率')
    benchmark_return = Column(Float, comment='基准收益率')
    alpha = Column(Float, comment='超额收益')
    sharpe_ratio = Column(Float, comment='夏普比率')
    max_drawdown = Column(Float, comment='最大回撤')
    update_time = Column(DateTime, default=func.now())

    def __repr__(self):
        return f"<BacktestResults({self.strategy_name}, {self.rebalance_date})>"


class QualitativeScores(Base):
    """定性评分预设库"""
    __tablename__ = 'qualitative_scores'

    id = Column(Integer, primary_key=True, autoincrement=True)
    industry_code = Column(String(10), nullable=False, unique=True)
    industry_name = Column(String(50), nullable=False)

    policy_score = Column(Float, default=3, comment='政策环境5分')
    policy_reason = Column(Text, comment='政策评分理由')

    business_model_score = Column(Float, default=3, comment='商业模式5分')
    business_model_reason = Column(Text, comment='商业模式评分理由')

    barrier_score = Column(Float, default=3, comment='进入壁垒5分')
    barrier_reason = Column(Text, comment='壁垒评分理由')

    moat_score = Column(Float, default=3, comment='护城河5分')
    moat_reason = Column(Text, comment='护城河评分理由')

    last_review_date = Column(Date, comment='最后审核日期')
    update_time = Column(DateTime, default=func.now(), onupdate=func.now())

    def __repr__(self):
        return f"<QualitativeScores({self.industry_code})>"
```

#### 3.2.2 数据库初始化脚本

```python
# scripts/init_database.py

from sqlalchemy import create_engine
from src.data.models import Base
from src.utils.config_loader import load_config
from loguru import logger

def init_database():
    """初始化数据库"""
    config = load_config()
    db_config = config['database']

    # 构建连接字符串
    db_url = (
        f"mysql+pymysql://{db_config['username']}:{db_config['password']}"
        f"@{db_config['host']}:{db_config['port']}/{db_config['database']}"
        f"?charset={db_config.get('charset', 'utf8mb4')}"
    )

    # 创建引擎
    engine = create_engine(db_url, echo=True)

    # 创建所有表
    logger.info("Creating all tables...")
    Base.metadata.create_all(engine)
    logger.success("Database initialized successfully!")

if __name__ == '__main__':
    init_database()
```

---

### 3.3 配置文件设计

#### 3.3.1 主配置文件

```yaml
# config/config.yaml

# 数据库配置
database:
  host: 'localhost'
  port: 3306
  username: 'your_username'
  password: 'your_password'
  database: 'industry_screener'
  charset: 'utf8mb4'
  pool_size: 10
  max_overflow: 20

# iFinD API配置
ifind_api:
  username: 'your_ifind_username'
  password: 'your_ifind_password'
  max_retries: 3
  retry_interval: 5  # 秒
  rate_limit: 1      # 每秒最多1次请求
  timeout: 30        # 超时时间(秒)

# 数据更新调度配置
scheduler:
  quarterly_data:
    enabled: true
    cron: '0 9 * * 1'  # 每周一9点检查是否有新季报
    lookback_days: 10   # 向前查找10天内披露的季报

  monthly_data:
    enabled: true
    cron: '0 10 15 * *'  # 每月15日10点更新

  weekly_data:
    enabled: true
    cron: '0 9 * * 1'    # 每周一9点更新

  annual_data:
    enabled: true
    cron: '0 9 * * 1'    # 每周一9点检查年报

# 日志配置
logging:
  level: 'INFO'
  rotation: '100 MB'
  retention: '30 days'
  format: '<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>'

# 缓存配置(可选)
cache:
  enabled: false
  redis_host: 'localhost'
  redis_port: 6379
  redis_db: 0
  ttl: 3600  # 缓存过期时间(秒)

# 其他配置
app:
  name: 'Industry Screener'
  version: '1.0.0'
  debug: false
```

#### 3.3.2 评分权重配置

```yaml
# config/scoring_weights.yaml

# 评分权重配置(所有权重可调整)

competition:  # 竞争格局 15分
  total_weight: 15
  sub_items:
    cr5:
      weight: 5
      rules:
        - condition: '>= 60'
          score: 5
        - condition: '>= 40 and < 60'
          score: 4
        - condition: '>= 20 and < 40'
          score: 2
        - condition: '< 20'
          score: 0

    leader_share_change:
      weight: 5
      rules:
        - condition: '>= 0.5'
          score: 5
          description: '持续提升'
        - condition: '>= -0.3 and < 0.5'
          score: 3
          description: '基本稳定'
        - condition: '< -0.5'
          score: 0
          description: '持续下降'

    price_volatility:
      weight: 3
      rules:
        - condition: '< 10'
          score: 3
        - condition: '>= 10 and < 20'
          score: 2
        - condition: '>= 20'
          score: 0

    capacity_utilization:
      weight: 2
      rules:
        - condition: '> 85'
          score: 2
        - condition: '>= 70 and <= 85'
          score: 1
        - condition: '< 70'
          score: 0

profitability:  # 盈利能力 15分
  total_weight: 15
  sub_items:
    roe_level:
      weight: 8
      rules:
        - condition: 'above_market_median and above_hist_50pct'
          score: 8
        - condition: 'above_market_median or above_hist_50pct'
          score: 4
        - condition: 'else'
          score: 0

    roe_trend:
      weight: 3
      rules:
        - condition: 'improving'
          score: 3
        - condition: 'stable'
          score: 2
        - condition: 'declining'
          score: 0

    gross_margin_level:
      weight: 2
      rules:
        - condition: 'above_5y_avg'
          score: 2
        - condition: 'else'
          score: 0

    gross_margin_trend:
      weight: 2
      rules:
        - condition: 'rising'
          score: 2
        - condition: 'stable'
          score: 1
        - condition: 'falling'
          score: 0

growth:  # 成长性 10分
  total_weight: 10
  gdp_growth_rate: 5  # GDP增速基准(可动态调整)
  sub_items:
    revenue_growth:
      weight: 5
      rules:
        - condition: '> gdp + 3'
          score: 5
        - condition: '> gdp'
          score: 3
        - condition: '> 0'
          score: 1
        - condition: '<= 0'
          score: 0

    profit_growth:
      weight: 3
      rules:
        - condition: '> revenue_growth'
          score: 3
        - condition: 'approximately_equal to revenue_growth'
          score: 2
        - condition: '< revenue_growth'
          score: 0

    profit_elasticity:
      weight: 2
      rules:
        - condition: '> 1.2'
          score: 2
        - condition: '>= 0.8 and <= 1.2'
          score: 1
        - condition: '< 0.8'
          score: 0

cashflow:  # 现金流 10分
  total_weight: 10
  sub_items:
    ocf_ni_ratio:
      weight: 6
      rules:
        - condition: '> 100'
          score: 6
        - condition: '>= 80 and <= 100'
          score: 4
        - condition: '>= 50 and < 80'
          score: 2
        - condition: '< 50'
          score: 0

    capex_intensity:
      weight: 4
      rules:
        - condition: '>= 1 and <= 2'
          score: 4
        - condition: '(>= 0.8 and < 1) or (> 2 and <= 3)'
          score: 2
        - condition: '< 0.8 or > 3'
          score: 0

valuation:  # 估值 10分
  total_weight: 10
  sub_items:
    pe_percentile:
      weight: 4
      rules:
        - condition: '< 30'
          score: 4
        - condition: '>= 30 and < 50'
          score: 3
        - condition: '>= 50 and < 70'
          score: 1
        - condition: '>= 70'
          score: 0

    pb_percentile:
      weight: 3
      rules:
        - condition: '< 30'
          score: 3
        - condition: '>= 30 and < 50'
          score: 2
        - condition: '>= 50 and < 70'
          score: 1
        - condition: '>= 70'
          score: 0

    peg:
      weight: 3
      rules:
        - condition: '< 1'
          score: 3
        - condition: '>= 1 and < 1.5'
          score: 2
        - condition: '>= 1.5 and < 2'
          score: 1
        - condition: '>= 2'
          score: 0

sentiment:  # 景气度 5分
  total_weight: 5
  sub_items:
    pmi_new_order:
      weight: 2
      rules:
        - condition: 'pmi > 50 and new_order > 51'
          score: 2
        - condition: 'pmi > 50 or new_order > 51'
          score: 1
        - condition: 'else'
          score: 0

    m2_social_financing:
      weight: 1.5
      rules:
        - condition: '> 10'
          score: 1.5
        - condition: '>= 8 and <= 10'
          score: 1
        - condition: '< 8'
          score: 0

    ppi_cpi:
      weight: 1.5
      rules:
        - condition: 'fits_industry_type'
          score: 1.5
          description: '周期行业看PPI,消费行业看CPI'
        - condition: 'else'
          score: 0

cycle:  # 周期位置 5分
  total_weight: 5
  sub_items:
    inventory_cycle:
      weight: 3
      rules:
        - condition: 'passive_restocking'
          score: 3
          description: '被动补库存(景气上行)'
        - condition: 'active_destocking'
          score: 2
          description: '主动去库存(景气底部)'
        - condition: 'transition'
          score: 1
        - condition: 'else'
          score: 0

    inventory_turnover:
      weight: 2
      rules:
        - condition: 'days_declining'
          score: 2
        - condition: 'days_rising < 10%'
          score: 1
        - condition: 'days_rising >= 20%'
          score: 0

qualitative:  # 定性评分 20分
  policy: 5
  business_model: 5
  barrier: 5
  moat: 5

redline:  # 红线扣分
  gross_margin_decline:
    penalty: -10
    condition: '连续4季度下滑>5pct'

  revenue_decline:
    penalty: -10
    condition: '连续2季度下滑>20%'

  valuation_extreme:
    penalty: -10
    condition: 'PE或PB历史95%分位以上维持1月'

  fund_outflow:
    penalty: -10
    condition: '北向+主力资金连续8周流出>100亿'
```

#### 3.3.3 行业定性评分预设库

```yaml
# config/industry_qualitative.yaml

industries:
  - code: '801010.SI'
    name: '农林牧渔'
    policy_score: 4
    policy_reason: '乡村振兴战略支持,种业国产替代受重视'
    business_model_score: 3
    business_model_reason: '受周期影响大,养殖业规模效应明显'
    barrier_score: 2
    barrier_reason: '进入门槛较低,竞争激烈'
    moat_score: 2
    moat_reason: '品牌壁垒弱,资源壁垒(土地/水域)有一定作用'
    last_review: '2026-01-01'

  - code: '801030.SI'
    name: '化工'
    policy_score: 3
    policy_reason: '双碳政策下产能受限,新材料方向受支持'
    business_model_score: 3
    business_model_reason: '重资产,周期性强,细分领域差异大'
    barrier_score: 4
    barrier_reason: '资本密集,技术壁垒高,环保审批严格'
    moat_score: 3
    moat_reason: '龙头具备成本和规模优势'
    last_review: '2026-01-01'

  # ... 其余29个行业
```

---

## 四、开发流程与里程碑

### 4.1 Phase 1: 基础设施搭建 (预计2-3天)

**任务清单**:
- [x] 创建项目目录结构
- [ ] 编写配置文件加载器
- [ ] 配置日志系统
- [ ] 初始化MySQL数据库和表结构
- [ ] 编写数据库连接管理器
- [ ] 搭建基础开发环境(requirements.txt)

**交付物**:
- 完整的项目骨架
- 可运行的数据库初始化脚本
- 配置管理模块

---

### 4.2 Phase 2: 数据获取模块 (预计5-7天)

**任务清单**:
- [ ] 调研iFinD API文档,确认23个指标获取方法
- [ ] 实现IFindAPIClient核心类
- [ ] 实现频率限制和重试机制
- [ ] 实现23个指标的数据获取函数
- [ ] 编写数据验证器
- [ ] 开发历史数据批量获取脚本
- [ ] 单元测试(Mock API响应)

**交付物**:
- 完整的API封装模块
- 批量数据获取脚本
- 单元测试覆盖率>80%

**注意事项**:
- 需要真实iFinD账号进行API可行性验证
- 部分指标可能需要组合查询或计算得出
- 预留API调整接口,应对未来变化

---

### 4.3 Phase 3: 计算引擎 (预计4-5天)

**任务清单**:
- [ ] 实现历史分位计算函数
- [ ] 实现库存周期判断逻辑
- [ ] 实现PEG计算
- [ ] 实现趋势判断(上行/平稳/下行)
- [ ] 实现全A市场中位数计算
- [ ] 开发Calculator类,整合所有计算逻辑
- [ ] 单元测试(使用模拟数据)

**交付物**:
- Calculator模块
- 单元测试覆盖率>90%

---

### 4.4 Phase 4: 评分引擎 (预计3-4天)

**任务清单**:
- [ ] 实现评分规则解析器(基于YAML配置)
- [ ] 实现各维度评分函数(7个维度)
- [ ] 实现红线触发检测
- [ ] 实现定性评分加载
- [ ] 开发Scorer类
- [ ] 单元测试

**交付物**:
- Scorer模块
- 可灵活配置的评分系统

---

### 4.5 Phase 5: Streamlit可视化 (预计5-7天)

**任务清单**:
- [ ] 搭建Streamlit多页应用框架
- [ ] 开发页面1:行业评分总览
- [ ] 开发页面2:单行业详情页
- [ ] 开发页面3:历史趋势分析
- [ ] 开发页面4:红线监控面板
- [ ] 开发页面5:回测页面
- [ ] 开发可复用图表组件(雷达图/趋势图等)

**交付物**:
- 完整的Web界面
- 用户操作手册

---

### 4.6 Phase 6: 调度与回测 (预计4-5天)

**任务清单**:
- [ ] 实现APScheduler调度系统
- [ ] 实现季度/月度/周度更新逻辑
- [ ] 实现动态调整回测策略
- [ ] 实现回测指标计算(夏普/最大回撤等)
- [ ] 开发回测报告生成

**交付物**:
- 自动更新系统
- 回测模块

---

### 4.7 Phase 7: 个股筛选预留接口 (预计2-3天)

**任务清单**:
- [ ] 设计个股筛选数据表结构
- [ ] 预留个股数据获取接口
- [ ] 预留个股评分接口
- [ ] 编写扩展文档

**交付物**:
- 扩展接口文档
- 示例代码

---

### 4.8 Phase 8: 测试与文档 (预计3-4天)

**任务清单**:
- [ ] 集成测试
- [ ] 性能测试与优化
- [ ] 编写用户手册
- [ ] 编写API参考文档
- [ ] 编写部署指南
- [ ] Code Review

**交付物**:
- 完整文档集
- 测试报告
- 部署脚本

---

## 五、风险控制与应急方案

### 5.1 API数据获取风险

**风险**: iFinD API部分指标无法获取或格式不符

**应急方案**:
1. 优先使用替代指标
2. 手工补充缺失数据
3. 降低该指标权重或临时剔除

### 5.2 性能风险

**风险**: 大量历史数据导致计算缓慢

**应急方案**:
1. 增加数据索引
2. 使用分布式计算(Dask)
3. 引入Redis缓存高频查询数据

### 5.3 数据质量风险

**风险**: 部分行业数据缺失或异常

**应急方案**:
1. 使用行业中位数填充
2. 标记数据质量,在UI中提示
3. 人工审核异常值

---

## 六、后续优化方向

1. **多因子扩展**: 增加技术面、舆情面因子
2. **个股筛选**: 基于行业评分筛选个股
3. **组合优化**: 使用马科维茨模型优化权重
4. **实盘跟踪**: 对接券商API,实现自动调仓
5. **AI预测**: 使用机器学习优化评分权重

---

**文档结束**
