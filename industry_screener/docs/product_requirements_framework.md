# 股票筛选系统 - 产品需求框架（PRD Framework）

## 文档说明

**文档类型**：产品需求框架（高层次）
**目标**：定义产品整体架构、核心功能模块、技术边界
**下一步**：基于此框架编写详细需求文档

---

## 一、产品概述

### 1.1 产品定位

**产品名称**：股票筛选系统（Stock Screener）

**核心价值**：
- 从A股市场中自动筛选出"优质公司"
- 为价值投资者提供决策支持

**目标用户**：
- 个人价值投资者
- 量化研究员
- 投资顾问

### 1.2 产品范围

**本期包含**：
- ✅ 第一层：行业筛选（复用已有模块）
- ✅ 第二层：质量筛选（本期核心）
- ✅ 数据获取与存储
- ✅ 回测与验证
- ✅ CLI命令行工具

**本期不包含**：
- ❌ 第三层：择时策略（未来版本）
- ❌ Web界面（未来版本）
- ❌ 实时交易执行（未来版本）
- ❌ 组合管理（未来版本）
- ❌ 风险管理（未来版本）

---

## 二、系统架构

### 2.1 两层筛选架构

```
┌──────────────────────────────────────────────────────────┐
│                      股票筛选系统                          │
└──────────────────────────────────────────────────────────┘
                            │
                ┌───────────┴───────────┐
                ▼                       ▼
        ┌──────────────┐        ┌──────────────┐
        │  第一层      │        │  第二层      │
        │  行业筛选    │───────►│  质量筛选    │
        │  (已实现)    │        │  (本期)      │
        └──────────────┘        └──────────────┘
                │                       │
                ▼                       ▼
           优质行业              优质公司池
           (20-30个)            (50-100只)
           季度更新              季度更新
```

### 2.2 技术架构

```
┌─────────────────────────────────────────────────────────┐
│                    CLI 命令行界面                         │
│       quality-screen | backtest | report                │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                    核心业务层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 质量筛选器   │  │ 质量评分器   │  │ 回测引擎     │  │
│  │ QualityFilter│  │ QualityScorer│  │ Backtester   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐                    │
│  │ 公司池管理器 │  │ 报告生成器   │                    │
│  │ PoolManager  │  │ Reporter     │                    │
│  └──────────────┘  └──────────────┘                    │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                    数据访问层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 股票数据仓库 │  │ 行业数据仓库 │  │ 市场数据仓库 │  │
│  │ StockRepo    │  │ IndustryRepo │  │ MarketRepo   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                    数据源层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ iFinD API    │  │ 本地数据库   │  │ 缓存层       │  │
│  │ (Wind)       │  │ (SQLite)     │  │ (可选)       │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 三、核心功能模块

### 3.1 第二层：质量筛选模块

**模块目标**：从优质行业中筛选出基本面优秀的公司

**核心功能**：
1. **F-QS-001**: 基础资格筛选
   - ROE/ROIC门槛检查
   - 行业龙头地位判断（根据CR3动态调整）
   - 财务安全检查
   - 竞争优势基础检查

2. **F-QS-002**: 排除项过滤
   - ST股票过滤
   - 营收排名下降过滤
   - 估值陷阱识别（区分周期股）
   - 治理风险识别
   - 商誉地雷识别
   - 业绩下滑识别

3. **F-QS-003**: 质量评分
   - 财务质量评分（50分）
     - ROE稳定性（15分）
     - ROIC水平（15分）
     - 现金流质量（12分）
     - 负债率（8分）
   - 竞争优势评分（50分）
     - 龙头地位（15分）
     - 龙头地位趋势（10分）
     - 盈利能力优势（15分）
     - 成长性（10分）
   - 行业分散度控制（单一行业≤35%）

4. **F-QS-004**: 优质公司池管理
   - 季度更新
   - 历史版本管理
   - 变动追踪
   - 入池/出池原因记录

**输入**：
- 优质行业列表（来自第一层）
- 股票财务数据
- 行业数据

**输出**：
- 优质公司池（50-100只）
- 质量得分明细
- 筛选报告

---

### 3.2 数据获取与存储模块

**模块目标**：获取、存储、管理所需数据

**核心功能**：
1. **F-DM-001**: 股票数据获取
   - 基本信息（代码、名称、行业）
   - 财务数据（ROE、ROIC、现金流、负债率等）
   - 行情数据（价格、成交量）
   - 估值数据（PE、PB）

2. **F-DM-002**: 行业数据获取
   - 行业分类（申万一级、二级）
   - 行业成分股
   - 行业集中度（CR3）
   - 行业中位数指标（毛利率、ROE等）

3. **F-DM-003**: 数据存储
   - 原始数据存储
   - 计算指标存储
   - 筛选结果存储
   - 历史版本管理

4. **F-DM-004**: 数据验证
   - 数据完整性检查
   - 数据时效性检查
   - 数据有效性检查
   - 异常值处理

**数据源**：
- iFinD API（Wind）
- 本地SQLite数据库

---

### 3.3 回测与验证模块

**模块目标**：验证筛选策略的有效性

**核心功能**：
1. **F-BT-001**: 质量筛选回测
   - 优质公司池历史表现
   - 筛选准确率分析
   - 排除项有效性验证

2. **F-BT-002**: 对比分析
   - vs 基准指数（沪深300）
   - vs 行业指数
   - vs 随机选股

3. **F-BT-003**: 绩效指标计算
   - 年化收益率
   - 最大回撤
   - 夏普比率
   - 胜率统计

4. **F-BT-004**: 报告生成
   - 回测报告
   - 绩效指标
   - 可视化图表

---

### 3.4 CLI命令行工具

**模块目标**：提供用户交互界面

**核心功能**：
1. **F-CLI-001**: 质量筛选命令
   ```bash
   python -m industry_screener quality-screen --date 2024-03-31
   ```

2. **F-CLI-002**: 公司池查询命令
   ```bash
   python -m industry_screener pool-list --date 2024-03-31
   python -m industry_screener pool-detail --code 600519
   ```

3. **F-CLI-003**: 回测命令
   ```bash
   python -m industry_screener backtest --start 2020-01-01 --end 2024-12-31
   ```

4. **F-CLI-004**: 报告命令
   ```bash
   python -m industry_screener report --type quality --date 2024-03-31
   ```

5. **F-CLI-005**: 数据更新命令
   ```bash
   python -m industry_screener data-update --type financial --date 2024-03-31
   ```

---

## 四、数据模型框架

### 4.1 核心实体

```
Stock (股票)
├── code: str                    # 股票代码
├── name: str                    # 股票名称
├── industry_l1: str             # 申万一级行业
├── industry_l2: str             # 申万二级行业
└── listing_date: date           # 上市日期

StockFinancial (股票财务数据)
├── stock_code: str              # 股票代码
├── report_date: date            # 报告期
├── roe: float                   # ROE
├── roic: float                  # ROIC
├── revenue: float               # 营收
├── net_profit: float            # 净利润
├── ocf: float                   # 经营现金流
├── total_assets: float          # 总资产
├── total_liabilities: float     # 总负债
├── current_ratio: float         # 流动比率
├── quick_ratio: float           # 速动比率
├── gross_margin: float          # 毛利率
├── goodwill_ratio: float        # 商誉/净资产
├── pledge_ratio: float          # 大股东质押比例
└── related_transaction_ratio: float  # 关联交易占比

StockMarket (股票行情数据)
├── stock_code: str              # 股票代码
├── trade_date: date             # 交易日期
├── close: float                 # 收盘价
├── high: float                  # 最高价
├── low: float                   # 最低价
├── volume: float                # 成交量
├── pe_ttm: float                # 滚动市盈率
└── pb: float                    # 市净率

QualityScore (质量评分)
├── stock_code: str              # 股票代码
├── score_date: date             # 评分日期
├── report_date: date            # 报告期
├── total_score: float           # 总分
├── financial_score: float       # 财务质量得分
├── competitive_score: float     # 竞争优势得分
├── roe_score: float             # ROE得分
├── roic_score: float            # ROIC得分
├── cashflow_score: float        # 现金流得分
├── leverage_score: float        # 负债率得分
├── leader_score: float          # 龙头地位得分
├── leader_trend_score: float    # 龙头趋势得分
├── margin_score: float          # 盈利优势得分
├── growth_score: float          # 成长性得分
├── pass_filters: bool           # 是否通过排除项
└── filter_reasons: str          # 未通过原因（如有）

QualityPool (优质公司池)
├── pool_date: date              # 池日期
├── stock_code: str              # 股票代码
├── total_score: float           # 总分
├── rank: int                    # 排名
├── reason: str                  # 入池理由
├── is_new: bool                 # 是否新入池
└── previous_rank: int           # 上期排名

Industry (行业)
├── code: str                    # 行业代码
├── name: str                    # 行业名称
├── level: int                   # 层级（1/2）
├── parent_code: str             # 父行业代码
└── cr3: float                   # 前3名集中度

IndustryMetrics (行业指标)
├── industry_code: str           # 行业代码
├── calc_date: date              # 计算日期
├── median_roe: float            # 中位数ROE
├── median_gross_margin: float   # 中位数毛利率
├── cr3: float                   # 前3名集中度
└── total_revenue: float         # 行业总营收
```

### 4.2 数据关系

```
Stock 1:N StockFinancial
Stock 1:N StockMarket
Stock 1:N QualityScore
Stock 1:N QualityPool
Stock N:1 Industry
Industry 1:N IndustryMetrics
```

---

## 五、技术边界

### 5.1 技术栈

**后端**：
- Python 3.10+
- SQLAlchemy 2.0+ (ORM)
- Pandas (数据处理)
- NumPy (数值计算)
- Loguru (日志)

**数据库**：
- SQLite (本地存储)

**数据源**：
- iFinD API (Wind)

**CLI**：
- Click (命令行框架)
- Rich (终端美化)

**测试**：
- Pytest (单元测试)
- Coverage (覆盖率)

### 5.2 性能要求

**响应时间**：
- 质量筛选：< 5分钟（全市场5000只股票）
- 公司池查询：< 1秒
- 回测：< 10分钟（5年历史数据）

**数据量**：
- 股票数量：~5000只
- 财务数据：~5年 × 4季度 × 5000只 = 10万条
- 行情数据：~5年 × 250天 × 5000只 = 625万条

**并发**：
- 单用户使用，无并发要求

### 5.3 数据更新频率

| 数据类型 | 更新频率 | 数据源 |
|---------|---------|--------|
| 股票基本信息 | 周更新 | iFinD |
| 财务数据 | 季度更新 | iFinD |
| 行情数据 | 日更新 | iFinD |
| 估值数据 | 日更新 | iFinD |
| 行业数据 | 季度更新 | iFinD |
| 行业指标 | 季度更新 | 计算 |
| 优质公司池 | 季度更新 | 计算 |

---

## 六、配置管理框架

### 6.1 配置文件结构

```
config/
├── quality_filter_rules.yaml        # 质量筛选规则
├── quality_scoring_weights.yaml     # 质量评分权重
├── data_sources.yaml                # 数据源配置
├── backtest_params.yaml             # 回测参数
└── strategy_presets/                # 策略预设
    ├── conservative.yaml            # 保守策略
    ├── balanced.yaml                # 平衡策略
    └── aggressive.yaml              # 激进策略
```

### 6.2 配置项分类

**质量筛选配置**：
- ROE/ROIC门槛
- 行业集中度阈值（CR3）
- 财务安全指标
- 排除项规则
- 评分权重
- 行业分散度限制

**数据源配置**：
- iFinD API配置
- 数据库连接
- 数据更新频率

**回测配置**：
- 回测时间范围
- 再平衡频率
- 基准指数
- 绩效指标

---

## 七、实施路线图

### Phase 1: 数据基础（2周）
- [ ] 设计数据库模型
- [ ] 实现Stock、StockFinancial、StockMarket等基础表
- [ ] 实现数据获取模块（iFinD API封装）
- [ ] 实现数据存储模块（Repository层）
- [ ] 数据验证与清洗

### Phase 2: 质量筛选核心（3周）
- [ ] 实现基础资格筛选
  - ROE/ROIC计算与检查
  - 行业龙头判断（CR3动态调整）
  - 财务安全检查
- [ ] 实现排除项过滤
  - ST股票过滤
  - 营收排名下降过滤
  - 估值陷阱识别（区分周期股）
  - 治理风险识别
  - 商誉地雷识别
  - 业绩下滑识别
- [ ] 单元测试

### Phase 3: 质量评分引擎（2周）
- [ ] 实现财务质量评分
  - ROE稳定性评分
  - ROIC水平评分
  - 现金流质量评分
  - 负债率评分
- [ ] 实现竞争优势评分
  - 龙头地位评分
  - 龙头地位趋势评分
  - 盈利能力优势评分
  - 成长性评分
- [ ] 实现行业分散度控制
- [ ] 单元测试

### Phase 4: 公司池管理（1周）
- [ ] 实现优质公司池管理
  - 季度更新逻辑
  - 历史版本管理
  - 变动追踪
  - 入池/出池原因记录
- [ ] 单元测试

### Phase 5: 回测验证（2周）
- [ ] 实现回测引擎
  - 历史数据回放
  - 再平衡逻辑
- [ ] 实现绩效指标计算
  - 年化收益率
  - 最大回撤
  - 夏普比率
  - 胜率统计
- [ ] 实现报告生成
  - 回测报告
  - 可视化图表
- [ ] 策略优化

### Phase 6: CLI工具（1周）
- [ ] 实现命令行界面
  - quality-screen命令
  - pool-list/pool-detail命令
  - backtest命令
  - report命令
  - data-update命令
- [ ] 实现配置管理
- [ ] 用户文档

### Phase 7: 集成测试（1周）
- [ ] 端到端测试
- [ ] 性能测试
- [ ] Bug修复
- [ ] 文档完善

**总计**：12周

---

## 八、风险与假设

### 8.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| iFinD API限流 | 高 | 增加缓存、限速控制、分批获取 |
| 数据质量问题 | 高 | 数据验证、异常处理、人工复核 |
| 计算性能瓶颈 | 中 | 优化算法、并行计算、增量计算 |
| 数据存储空间 | 低 | 数据压缩、定期清理历史数据 |
| ROIC计算复杂 | 中 | 简化公式、提供备选方案 |

### 8.2 业务假设

1. **数据可得性**：假设iFinD API能提供所需的所有数据
2. **数据准确性**：假设iFinD数据准确可靠
3. **策略有效性**：假设筛选策略在历史数据上有效
4. **市场稳定性**：假设市场规则不会发生重大变化
5. **行业分类稳定**：假设申万行业分类不会频繁调整

### 8.3 依赖项

- iFinD API账号与权限
- Python开发环境（3.10+）
- 足够的存储空间（~10GB）
- 稳定的网络连接

---

## 九、成功指标

### 9.1 功能指标

- ✅ 质量筛选能筛选出50-100只优质公司
- ✅ 评分系统能合理区分公司质量
- ✅ 回测系统能验证策略有效性
- ✅ CLI工具能正常运行
- ✅ 数据更新能自动化执行

### 9.2 性能指标

- ✅ 质量筛选 < 5分钟
- ✅ 公司池查询 < 1秒
- ✅ 回测 < 10分钟
- ✅ 数据准确率 > 95%
- ✅ 单元测试覆盖率 > 80%

### 9.3 业务指标

- ✅ 优质公司池年化收益 > 沪深300
- ✅ 优质公司池最大回撤 < 沪深300
- ✅ 筛选准确率 > 70%（人工评估）
- ✅ 排除项有效性 > 80%（避免踩雷）

---

## 十、下一步行动

1. **评审本框架**：与相关方确认框架合理性
2. **编写详细需求文档**：基于本框架展开详细设计
   - 数据库详细设计
   - API接口设计
   - 算法详细设计
   - 测试用例设计
3. **环境准备**：
   - 申请iFinD API权限
   - 搭建开发环境
   - 准备测试数据
4. **开始开发**：按照实施路线图执行

---

**文档版本**：v1.1
**创建日期**：2026-01-19
**更新日期**：2026-01-19
**变更说明**：去掉第三层择时策略，聚焦质量筛选
