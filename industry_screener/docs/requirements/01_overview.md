# 股票筛选系统 - 详细需求文档

## 文档信息

**文档类型**：详细需求文档（PRD - Product Requirements Document）
**版本**：v1.0
**创建日期**：2026-01-19
**作者**：系统设计团队
**状态**：待评审

---

## 目录

1. [概述](./01_overview.md)（本文档）
2. [数据库设计](./02_database_design.md)
3. [质量筛选模块](./03_quality_screening.md)
4. [数据获取模块](./04_data_acquisition.md)
5. [回测验证模块](./05_backtesting.md)
6. [CLI工具](./06_cli_tools.md)
7. [配置管理](./07_configuration.md)
8. [测试计划](./08_testing.md)

---

## 1. 产品概述

### 1.1 背景

价值投资的核心是找到"优质公司"并在合适的价格买入。然而，A股市场有5000+只股票，人工筛选效率低且容易遗漏。本系统旨在通过量化指标自动筛选出基本面优秀的公司，为投资决策提供支持。

### 1.2 目标

**核心目标**：
- 从A股市场中自动筛选出50-100只"优质公司"
- 优质公司定义：ROE≥12%、ROIC≥10%、行业龙头、财务安全、有竞争优势

**次要目标**：
- 通过回测验证筛选策略的有效性
- 提供清晰的筛选报告和评分明细
- 支持策略参数调整和优化

### 1.3 用户角色

| 角色 | 描述 | 主要需求 |
|------|------|----------|
| 个人投资者 | 价值投资理念的个人投资者 | 获取优质公司池，了解评分依据 |
| 量化研究员 | 进行策略研究和回测 | 调整参数，验证策略有效性 |
| 投资顾问 | 为客户提供投资建议 | 生成专业报告，解释筛选逻辑 |

### 1.4 产品范围

**本期包含**：
- ✅ 质量筛选：三道关卡（资格筛选、排除项、评分）
- ✅ 数据管理：获取、存储、验证
- ✅ 回测验证：历史表现分析
- ✅ CLI工具：命令行操作界面
- ✅ 配置管理：灵活的参数配置

**本期不包含**：
- ❌ 择时策略（未来版本）
- ❌ Web界面（未来版本）
- ❌ 实时交易（未来版本）
- ❌ 组合管理（未来版本）

---

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    CLI 命令行界面                         │
│  quality-screen | pool-list | backtest | report         │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                    核心业务层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 质量筛选器   │  │ 质量评分器   │  │ 回测引擎     │  │
│  │ QualityFilter│  │ QualityScorer│  │ Backtester   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐                    │
│  │ 公司池管理器 │  │ 报告生成器   │                    │
│  │ PoolManager  │  │ Reporter     │                    │
│  └──────────────┘  └──────────────┘                    │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                    数据访问层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 股票数据仓库 │  │ 行业数据仓库 │  │ 评分数据仓库 │  │
│  │ StockRepo    │  │ IndustryRepo │  │ ScoreRepo    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                    数据源层                               │
│  ┌──────────────┐  ┌──────────────┐                    │
│  │ iFinD API    │  │ 本地数据库   │                    │
│  │ (Wind)       │  │ (SQLite)     │                    │
│  └──────────────┘  └──────────────┘                    │
└─────────────────────────────────────────────────────────┘
```

### 2.2 技术栈

| 层级 | 技术选型 | 说明 |
|------|---------|------|
| 编程语言 | Python 3.10+ | 主流数据分析语言 |
| ORM | SQLAlchemy 2.0+ | 数据库访问 |
| 数据处理 | Pandas, NumPy | 数据分析和计算 |
| 数据库 | SQLite | 轻量级本地数据库 |
| CLI框架 | Click | 命令行工具 |
| 终端美化 | Rich | 终端输出美化 |
| 日志 | Loguru | 日志管理 |
| 测试 | Pytest | 单元测试 |
| 数据源 | iFinD API | Wind金融终端 |

### 2.3 目录结构

```
industry_screener/
├── src/
│   ├── core/                    # 核心业务逻辑
│   │   ├── quality_filter.py    # 质量筛选器
│   │   ├── quality_scorer.py    # 质量评分器
│   │   ├── pool_manager.py      # 公司池管理器
│   │   ├── backtester.py        # 回测引擎
│   │   └── reporter.py          # 报告生成器
│   │
│   ├── data/                    # 数据访问层
│   │   ├── models.py            # 数据模型
│   │   ├── repository.py        # 数据仓库
│   │   ├── ifind_client.py      # iFinD API客户端
│   │   └── data_validator.py   # 数据验证器
│   │
│   ├── utils/                   # 工具类
│   │   ├── constants.py         # 常量定义
│   │   ├── calculator.py        # 计算工具
│   │   └── config_loader.py    # 配置加载器
│   │
│   └── cli/                     # 命令行工具
│       ├── quality_cmd.py       # 质量筛选命令
│       ├── pool_cmd.py          # 公司池查询命令
│       ├── backtest_cmd.py      # 回测命令
│       └── report_cmd.py        # 报告命令
│
├── config/                      # 配置文件
│   ├── quality_filter_rules.yaml
│   ├── quality_scoring_weights.yaml
│   ├── data_sources.yaml
│   └── backtest_params.yaml
│
├── tests/                       # 测试代码
│   ├── unit/                    # 单元测试
│   ├── integration/             # 集成测试
│   └── fixtures/                # 测试数据
│
├── docs/                        # 文档
│   ├── requirements/            # 需求文档
│   ├── api/                     # API文档
│   └── user_guide/              # 用户指南
│
├── data/                        # 数据目录
│   ├── database/                # 数据库文件
│   ├── cache/                   # 缓存文件
│   └── reports/                 # 报告输出
│
└── logs/                        # 日志目录
```

---

## 3. 核心流程

### 3.1 质量筛选流程

```
输入：优质行业列表（来自第一层）
  ↓
步骤1：获取行业成分股
  → 从数据库或iFinD API获取
  → 预期：每个行业10-50只股票
  ↓
步骤2：计算行业集中度CR3
  → 前3名营收之和 / 行业总营收
  → 确定各行业的龙头标准
  ↓
步骤3：基础资格筛选（Pass/Fail）
  → ROE 3年平均≥12% 且 ROIC 3年平均≥10%
  → 行业龙头（根据CR3动态调整）
  → 财务安全（负债率、流动比率等）
  → 竞争优势基础（营收排名或毛利率）
  ↓
步骤4：排除项过滤（一票否决）
  → ST股票
  → 营收排名持续下降
  → 估值陷阱（区分周期股）
  → 治理风险
  → 商誉地雷
  → 业绩下滑
  ↓
步骤5：质量评分（100分制）
  → 财务质量（50分）
  → 竞争优势（50分）
  ↓
步骤6：筛选入池
  → 总分≥60分的股票入池
  → 按得分排序
  ↓
步骤7：行业分散度控制
  → 单一行业最多占35%
  → 超出部分按得分截取
  ↓
输出：优质公司池（50-100只）
```

### 3.2 数据更新流程

```
触发：定时任务或手动命令
  ↓
步骤1：检查数据时效性
  → 财务数据：季度更新
  → 行情数据：日更新
  ↓
步骤2：从iFinD API获取数据
  → 批量获取，避免限流
  → 重试机制
  ↓
步骤3：数据验证
  → 完整性检查
  → 有效性检查
  → 异常值处理
  ↓
步骤4：存储到数据库
  → 原始数据表
  → 计算指标表
  ↓
步骤5：记录更新日志
  → 更新时间
  → 更新数量
  → 错误信息
```

### 3.3 回测流程

```
输入：回测参数（时间范围、再平衡频率）
  ↓
步骤1：历史数据准备
  → 加载历史财务数据
  → 加载历史行情数据
  ↓
步骤2：时间序列回放
  → 按季度遍历
  → 每个季度执行筛选
  ↓
步骤3：计算持仓收益
  → 等权持仓
  → 计算区间收益
  ↓
步骤4：再平衡
  → 按频率调整持仓
  → 记录换手率
  ↓
步骤5：绩效指标计算
  → 年化收益率
  → 最大回撤
  → 夏普比率
  → 胜率统计
  ↓
步骤6：对比分析
  → vs 沪深300
  → vs 行业指数
  ↓
输出：回测报告
```

---

## 4. 非功能性需求

### 4.1 性能要求

| 指标 | 要求 | 说明 |
|------|------|------|
| 质量筛选 | < 5分钟 | 全市场5000只股票 |
| 公司池查询 | < 1秒 | 单次查询 |
| 回测 | < 10分钟 | 5年历史数据 |
| 数据更新 | < 30分钟 | 全量更新 |

### 4.2 可靠性要求

- **数据准确率**：> 95%
- **系统可用性**：> 99%（本地系统）
- **错误恢复**：自动重试机制
- **数据备份**：每日自动备份

### 4.3 可维护性要求

- **代码覆盖率**：> 80%
- **文档完整性**：所有公开API有文档
- **日志记录**：关键操作有日志
- **配置化**：核心参数可配置

### 4.4 可扩展性要求

- **模块化设计**：各模块低耦合
- **接口标准化**：统一的数据接口
- **配置驱动**：策略参数可配置
- **插件化**：支持自定义评分规则

---

## 5. 约束条件

### 5.1 技术约束

- Python 3.10+
- 本地运行，无服务器部署
- SQLite数据库（单文件）
- iFinD API依赖

### 5.2 业务约束

- 仅支持A股市场
- 使用申万行业分类
- 季度更新频率
- 单用户使用

### 5.3 数据约束

- 依赖iFinD API数据质量
- 财务数据有季度延迟
- 历史数据回溯5年

---

## 6. 风险与假设

### 6.1 风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| iFinD API限流 | 高 | 中 | 缓存、限速、分批 |
| 数据质量问题 | 高 | 中 | 验证、人工复核 |
| ROIC计算复杂 | 中 | 高 | 简化公式、备选方案 |
| 性能瓶颈 | 中 | 低 | 优化算法、并行计算 |

### 6.2 假设

1. iFinD API能提供所需的所有数据
2. iFinD数据准确可靠
3. 筛选策略在历史数据上有效
4. 申万行业分类不会频繁调整
5. 用户有基本的Python使用能力

---

## 7. 成功指标

### 7.1 功能指标

- ✅ 能筛选出50-100只优质公司
- ✅ 评分系统能合理区分质量
- ✅ 回测系统能验证有效性
- ✅ CLI工具能正常运行

### 7.2 性能指标

- ✅ 质量筛选 < 5分钟
- ✅ 公司池查询 < 1秒
- ✅ 回测 < 10分钟
- ✅ 数据准确率 > 95%

### 7.3 业务指标

- ✅ 优质公司池年化收益 > 沪深300
- ✅ 优质公司池最大回撤 < 沪深300
- ✅ 筛选准确率 > 70%（人工评估）
- ✅ 排除项有效性 > 80%（避免踩雷）

---

## 8. 下一步

1. 评审本需求文档
2. 阅读各子文档了解详细设计
3. 准备开发环境
4. 开始Phase 1开发

---

**相关文档**：
- [数据库设计](./02_database_design.md)
- [质量筛选模块](./03_quality_screening.md)
- [数据获取模块](./04_data_acquisition.md)
- [回测验证模块](./05_backtesting.md)
- [CLI工具](./06_cli_tools.md)
